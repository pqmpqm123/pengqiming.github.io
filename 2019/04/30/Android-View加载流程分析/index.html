<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
  <title>Android View加载流程分析 | 彭启明的技术小屋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="上一章节我们讲了Activity加载的启动的流程，那么Activity启动后，是如何显示咱们的写的View的？下面咱们就开始新的旅程。   首先在还记的ActivityThread在启动Activity里的onCreate()方法之前，是先调用的attach()方法，那么他为什么会调用这个方法呢，他在这个方法里干了什么呢？故事就这样开始了，不多少看一下Attach（）代码   1234567891">
<meta property="og:type" content="article">
<meta property="og:title" content="Android View加载流程分析">
<meta property="og:url" content="http://yoursite.com/2019/04/30/Android-View加载流程分析/index.html">
<meta property="og:site_name" content="彭启明的技术小屋">
<meta property="og:description" content="上一章节我们讲了Activity加载的启动的流程，那么Activity启动后，是如何显示咱们的写的View的？下面咱们就开始新的旅程。   首先在还记的ActivityThread在启动Activity里的onCreate()方法之前，是先调用的attach()方法，那么他为什么会调用这个方法呢，他在这个方法里干了什么呢？故事就这样开始了，不多少看一下Attach（）代码   1234567891">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/007e4h7Uly1g2kgrk7swtj31g512hgq0.jpg">
<meta property="og:updated_time" content="2019-04-30T02:48:54.372Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android View加载流程分析">
<meta name="twitter:description" content="上一章节我们讲了Activity加载的启动的流程，那么Activity启动后，是如何显示咱们的写的View的？下面咱们就开始新的旅程。   首先在还记的ActivityThread在启动Activity里的onCreate()方法之前，是先调用的attach()方法，那么他为什么会调用这个方法呢，他在这个方法里干了什么呢？故事就这样开始了，不多少看一下Attach（）代码   1234567891">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/007e4h7Uly1g2kgrk7swtj31g512hgq0.jpg">
  
    <link rel="alternate" href="/atom.xml" title="彭启明的技术小屋" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">彭启明的技术小屋</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android-View加载流程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/30/Android-View加载流程分析/" class="article-date">
  <time datetime="2019-04-30T02:46:30.000Z" itemprop="datePublished">2019-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android View加载流程分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一章节我们讲了Activity加载的启动的流程，那么Activity启动后，是如何显示咱们的写的View的？下面咱们就开始新的旅程。 </p>
<p><img src="http://ww1.sinaimg.cn/large/007e4h7Uly1g2kgrk7swtj31g512hgq0.jpg" alt></p>
<p>首先在还记的ActivityThread在启动Activity里的onCreate()方法之前，是先调用的attach()方法，那么他为什么会调用这个方法呢，他在这个方法里干了什么呢？故事就这样开始了，不多少看一下Attach（）代码  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">final void attach(Context context, ActivityThread aThread,</span><br><span class="line">        Instrumentation instr, IBinder token, int ident,</span><br><span class="line">        Application application, Intent intent, ActivityInfo info,</span><br><span class="line">        CharSequence title, Activity parent, String id,</span><br><span class="line">        NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">        Window window, ActivityConfigCallback activityConfigCallback) &#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">    mFragments.attachHost(null /*parent*/);</span><br><span class="line"></span><br><span class="line">    mWindow = new PhoneWindow(this, window, activityConfigCallback);</span><br><span class="line">    mWindow.setWindowControllerCallback(this);</span><br><span class="line">    mWindow.setCallback(this);</span><br><span class="line">    mWindow.setOnWindowDismissedCallback(this);</span><br><span class="line">    mWindow.getLayoutInflater().setPrivateFactory(this);</span><br><span class="line">    if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">        mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">    &#125;</span><br><span class="line">    .........</span><br><span class="line">    ......</span><br><span class="line">    ...</span><br><span class="line">    if (voiceInteractor != null) &#123;</span><br><span class="line">        if (lastNonConfigurationInstances != null) &#123;</span><br><span class="line">            mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this,</span><br><span class="line">                    Looper.myLooper());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);</span><br><span class="line">    if (mParent != null) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line"></span><br><span class="line">    mWindow.setColorMode(info.colorMode);</span><br><span class="line"></span><br><span class="line">    setAutofillCompatibilityEnabled(application.isAutofillCompatibilityEnabled());</span><br><span class="line">    enableAutofillCompatibilityIfNeeded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先创建了一个PhoneWindow对象，然后设置了WindowManager 对象，一看这个WindowManage的获取方式是通过getSystemService 获取的就知道这个也是通过binder进行获取的wms来进行管理PhoneWindow的。接下来看一下PhoneWindo 里面是如何创建。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class PhoneWindow extends Window&#123;</span><br><span class="line">    .......</span><br><span class="line">    ....</span><br><span class="line">    ..</span><br><span class="line">    /**</span><br><span class="line">     * Constructor for main window of an activity.</span><br><span class="line">     */</span><br><span class="line">    public PhoneWindow(Context context, Window preservedWindow,</span><br><span class="line">            ActivityConfigCallback activityConfigCallback) &#123;</span><br><span class="line">        this(context);</span><br><span class="line">        // Only main activity windows use decor context, all the other windows depend on whatever</span><br><span class="line">        // context that was given to them.</span><br><span class="line">        mUseDecorContext = true;</span><br><span class="line">        if (preservedWindow != null) &#123;</span><br><span class="line">            mDecor = (DecorView) preservedWindow.getDecorView();</span><br><span class="line">            mElevation = preservedWindow.getElevation();</span><br><span class="line">            mLoadElevation = false;</span><br><span class="line">            mForceDecorInstall = true;</span><br><span class="line">            // If we&apos;re preserving window, carry over the app token from the preserved</span><br><span class="line">            // window, as we&apos;ll be skipping the addView in handleResumeActivity(), and</span><br><span class="line">            // the token will not be updated as for a new window.</span><br><span class="line">            getAttributes().token = preservedWindow.getAttributes().token;</span><br><span class="line">        &#125;</span><br><span class="line">        // Even though the device doesn&apos;t support picture-in-picture mode,</span><br><span class="line">        // an user can force using it through developer options.</span><br><span class="line">        boolean forceResizable = Settings.Global.getInt(context.getContentResolver(),</span><br><span class="line">                DEVELOPMENT_FORCE_RESIZABLE_ACTIVITIES, 0) != 0;</span><br><span class="line">        mSupportsPictureInPicture = forceResizable || context.getPackageManager().hasSystemFeature(</span><br><span class="line">                PackageManager.FEATURE_PICTURE_IN_PICTURE);</span><br><span class="line">        mActivityConfigCallback = activityConfigCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过代码可以看出来，PhoneWindow继承window。看看构造函数吧，首先判断preservedWindow != null 那么就会从这个preservedWindow里取出DecorView，那么DecorView这个类是干什么的呢.咱们进去看一下大概了解一下  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class DecorView extends FrameLayout implements RootViewSurfaceTaker, WindowCallbacks &#123;</span><br><span class="line">    .......</span><br><span class="line">    ....</span><br><span class="line">    ..</span><br><span class="line">    .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看把这个是不是很熟悉，原来这个view 继承了FrameLayout，里面先不细说后面在说是怎么创建的，那么咱们往下看，看哪里？当然看onCreate()方法了，走完attach()方法就应该走onCreate() 了,我们经常在这个方法里进行布局设置setContentView()方法，咱们重点看一下在Activity类里这个方法是怎么把我们写的布局加载到视图里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void setContentView(@LayoutRes int layoutResID) &#123;</span><br><span class="line">     getWindow().setContentView(layoutResID);</span><br><span class="line">     initWindowDecorActionBar();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>getWindow().setContentView(layoutResID)，看一下getWindow() 其实就是之前在attach方法里看到的PhoneWindow这个类，那么咱们看一下PhoneWindow里的setContentView 是怎么实现的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void setContentView(int layoutResID) &#123;</span><br><span class="line">        // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span><br><span class="line">        // decor, when theme attributes and the like are crystalized. Do not check the feature</span><br><span class="line">        // before this happens.</span><br><span class="line">        if (mContentParent == null) &#123;</span><br><span class="line">            installDecor();</span><br><span class="line">        &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        final Callback cb = getCallback();</span><br><span class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParentExplicitlySet = true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>首先判断if (mContentParent == null) mContentParent是一个ViewGroup，如果这个是空那么执行installDecor()方法，咱们看一下这个方法干了什么事情  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">private void installDecor() &#123;</span><br><span class="line">       mForceDecorInstall = false;</span><br><span class="line">       if (mDecor == null) &#123;</span><br><span class="line">           mDecor = generateDecor(-1);</span><br><span class="line">           mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">           mDecor.setIsRootNamespace(true);</span><br><span class="line">           if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) &#123;</span><br><span class="line">               mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mDecor.setWindow(this);</span><br><span class="line">       &#125;</span><br><span class="line">       if (mContentParent == null) &#123;</span><br><span class="line">           mContentParent = generateLayout(mDecor);</span><br><span class="line"></span><br><span class="line">           // Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span><br><span class="line">           mDecor.makeOptionalFitsSystemWindows();</span><br><span class="line"></span><br><span class="line">           final DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</span><br><span class="line">                   R.id.decor_content_parent);</span><br><span class="line"></span><br><span class="line">           if (decorContentParent != null) &#123;</span><br><span class="line">               mDecorContentParent = decorContentParent;</span><br><span class="line">               mDecorContentParent.setWindowCallback(getCallback());</span><br><span class="line">               if (mDecorContentParent.getTitle() == null) &#123;</span><br><span class="line">                   mDecorContentParent.setWindowTitle(mTitle);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               final int localFeatures = getLocalFeatures();</span><br><span class="line">               for (int i = 0; i &lt; FEATURE_MAX; i++) &#123;</span><br><span class="line">                   if ((localFeatures &amp; (1 &lt;&lt; i)) != 0) &#123;</span><br><span class="line">                       mDecorContentParent.initFeature(i);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               mDecorContentParent.setUiOptions(mUiOptions);</span><br><span class="line"></span><br><span class="line">               if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) != 0 ||</span><br><span class="line">                       (mIconRes != 0 &amp;&amp; !mDecorContentParent.hasIcon())) &#123;</span><br><span class="line">                   mDecorContentParent.setIcon(mIconRes);</span><br><span class="line">               &#125; else if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) == 0 &amp;&amp;</span><br><span class="line">                       mIconRes == 0 &amp;&amp; !mDecorContentParent.hasIcon()) &#123;</span><br><span class="line">                   mDecorContentParent.setIcon(</span><br><span class="line">                           getContext().getPackageManager().getDefaultActivityIcon());</span><br><span class="line">                   mResourcesSetFlags |= FLAG_RESOURCE_SET_ICON_FALLBACK;</span><br><span class="line">               &#125;</span><br><span class="line">               if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_LOGO) != 0 ||</span><br><span class="line">                       (mLogoRes != 0 &amp;&amp; !mDecorContentParent.hasLogo())) &#123;</span><br><span class="line">                   mDecorContentParent.setLogo(mLogoRes);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               // Invalidate if the panel menu hasn&apos;t been created before this.</span><br><span class="line">               // Panel menu invalidation is deferred avoiding application onCreateOptionsMenu</span><br><span class="line">               // being called in the middle of onCreate or similar.</span><br><span class="line">               // A pending invalidation will typically be resolved before the posted message</span><br><span class="line">               // would run normally in order to satisfy instance state restoration.</span><br><span class="line">               PanelFeatureState st = getPanelState(FEATURE_OPTIONS_PANEL, false);</span><br><span class="line">               if (!isDestroyed() &amp;&amp; (st == null || st.menu == null) &amp;&amp; !mIsStartingWindow) &#123;</span><br><span class="line">                   invalidatePanelMenu(FEATURE_ACTION_BAR);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               mTitleView = findViewById(R.id.title);</span><br><span class="line">               if (mTitleView != null) &#123;</span><br><span class="line">                   if ((getLocalFeatures() &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) != 0) &#123;</span><br><span class="line">                       final View titleContainer = findViewById(R.id.title_container);</span><br><span class="line">                       if (titleContainer != null) &#123;</span><br><span class="line">                           titleContainer.setVisibility(View.GONE);</span><br><span class="line">                       &#125; else &#123;</span><br><span class="line">                           mTitleView.setVisibility(View.GONE);</span><br><span class="line">                       &#125;</span><br><span class="line">                       mContentParent.setForeground(null);</span><br><span class="line">                   &#125; else &#123;</span><br><span class="line">                       mTitleView.setText(mTitle);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (mDecor.getBackground() == null &amp;&amp; mBackgroundFallbackResource != 0) &#123;</span><br><span class="line">               mDecor.setBackgroundFallback(mBackgroundFallbackResource);</span><br><span class="line">           &#125;</span><br><span class="line">       .............</span><br><span class="line">       ....</span><br><span class="line">       ...</span><br><span class="line">       .</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>看这个判断if (mDecor == null) 这个就是咱们之前看到的DecorView这个类，如果是空就走generateDecor这个方法，接下来看一下这个方法怎么实现的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected DecorView generateDecor(int featureId) &#123;</span><br><span class="line">        // System process doesn&apos;t have application context and in that case we need to directly use</span><br><span class="line">        // the context we have. Otherwise we want the application context, so we don&apos;t cling to the</span><br><span class="line">        // activity.</span><br><span class="line">        Context context;</span><br><span class="line">        if (mUseDecorContext) &#123;</span><br><span class="line">            Context applicationContext = getContext().getApplicationContext();</span><br><span class="line">            if (applicationContext == null) &#123;</span><br><span class="line">                context = getContext();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                context = new DecorContext(applicationContext, getContext());</span><br><span class="line">                if (mTheme != -1) &#123;</span><br><span class="line">                    context.setTheme(mTheme);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            context = getContext();</span><br><span class="line">        &#125;</span><br><span class="line">        return new DecorView(context, featureId, this, getAttributes());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>很简单就是创建了一个DecorView对象，那么还是回到上个方法看一下，有了DecorView这个类，咱们往下走，if (mContentParent == null) ，判断mContentParent是否为空，mContentParent就是一个ViewGroup，如果为空就会通过mContentParent = generateLayout(mDecor);<br>通过这个方法创建一个，还是看看这个方法都看了什么  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</span><br><span class="line">     // Apply data from current theme.</span><br><span class="line"></span><br><span class="line">     TypedArray a = getWindowStyle();</span><br><span class="line">     ..................</span><br><span class="line">     ...............</span><br><span class="line">     ............</span><br><span class="line">        if (a.getBoolean(R.styleable.Window_windowTranslucentStatus,</span><br><span class="line">             false)) &#123;</span><br><span class="line">         setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS</span><br><span class="line">                 &amp; (~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if (a.getBoolean(R.styleable.Window_windowTranslucentNavigation,</span><br><span class="line">             false)) &#123;</span><br><span class="line">         setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION</span><br><span class="line">                 &amp; (~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if (a.getBoolean(R.styleable.Window_windowOverscan, false)) &#123;</span><br><span class="line">         setFlags(FLAG_LAYOUT_IN_OVERSCAN, FLAG_LAYOUT_IN_OVERSCAN&amp;(~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line">     .........</span><br><span class="line">     .....</span><br><span class="line">     ...</span><br><span class="line">     .</span><br><span class="line">      mDecor.startChanging();</span><br><span class="line">     mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">     ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">     if (contentParent == null) &#123;</span><br><span class="line">         throw new RuntimeException(&quot;Window couldn&apos;t find content container view&quot;);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if ((features &amp; (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != 0) &#123;</span><br><span class="line">         ProgressBar progress = getCircularProgressBar(false);</span><br><span class="line">         if (progress != null) &#123;</span><br><span class="line">             progress.setIndeterminate(true);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</span><br><span class="line">         registerSwipeCallbacks(contentParent);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // Remaining setup -- of background and title -- that only applies</span><br><span class="line">     // to top-level windows.</span><br><span class="line">     if (getContainer() == null) &#123;</span><br><span class="line">         final Drawable background;</span><br><span class="line">         if (mBackgroundResource != 0) &#123;</span><br><span class="line">             background = getContext().getDrawable(mBackgroundResource);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             background = mBackgroundDrawable;</span><br><span class="line">         &#125;</span><br><span class="line">         mDecor.setWindowBackground(background);</span><br><span class="line"></span><br><span class="line">         final Drawable frame;</span><br><span class="line">         if (mFrameResource != 0) &#123;</span><br><span class="line">             frame = getContext().getDrawable(mFrameResource);</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             frame = null;</span><br><span class="line">         &#125;</span><br><span class="line">         mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">         mDecor.setElevation(mElevation);</span><br><span class="line">         mDecor.setClipToOutline(mClipToOutline);</span><br><span class="line"></span><br><span class="line">         if (mTitle != null) &#123;</span><br><span class="line">             setTitle(mTitle);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (mTitleColor == 0) &#123;</span><br><span class="line">             mTitleColor = mTextColor;</span><br><span class="line">         &#125;</span><br><span class="line">         setTitleColor(mTitleColor);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mDecor.finishChanging();</span><br><span class="line"></span><br><span class="line">     return contentParent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>代码太长，找一些重点讲一下， ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT)  主要就是通过这个获取mContentParent 这个com.android.internal.R.id.content是不是很熟悉。 这样就把之前咱们传进来的布局跟DecorView添加到id为content里布局里了mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);<br>就是设置一下Activity的主题等。咱们在回过头看，在看 setContentView（）方法，获取到mContentParent，            mLayoutInflater.inflate(layoutResID, mContentParent);<br>就会执行这个方法，这个方法很熟悉，我们在通过布局创建view 的时候都会调用这个，最终会把布局inflate，mContentParent中，如果想细看LayoutInflater.inflate里的具体流程，看一下看我的……,这里就不在详解了，否则太长了。<br>现在DecorView也已经有了，咱们写的布局文件添加到mContentParent里了，接下来看看是怎么显示的吧，大家知道activity 启动的时候是走到onResume里的时候会显示出布局获取到焦点，那么看一下ActivityThread 里走到onResume里都做了什么  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void handleResumeActivity(IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">           String reason) &#123;</span><br><span class="line">       // If we are getting ready to gc after going to the background, well</span><br><span class="line">       // we are back active so skip it.</span><br><span class="line">       unscheduleGcIdler();</span><br><span class="line">       mSomeActivitiesChanged = true;</span><br><span class="line"></span><br><span class="line">       // TODO Push resumeArgs into the activity for consideration</span><br><span class="line">       final ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">       </span><br><span class="line">   </span><br><span class="line">           r.activity.mVisibleFromServer = true;</span><br><span class="line">           mNumVisibleActivities++;</span><br><span class="line">           if (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">               r.activity.makeVisible();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       r.nextIdle = mNewActivities;</span><br><span class="line">       mNewActivities = r;</span><br><span class="line">       if (localLOGV) Slog.v(TAG, &quot;Scheduling idle handler for &quot; + r);</span><br><span class="line">       Looper.myQueue().addIdleHandler(new Idler());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>重点看这里哦，r.activity.makeVisible()在进入activity里看一下这个方法  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void makeVisible() &#123;</span><br><span class="line">    if (!mWindowAdded) &#123;</span><br><span class="line">        ViewManager wm = getWindowManager();</span><br><span class="line">        wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">        mWindowAdded = true;</span><br><span class="line">    &#125;</span><br><span class="line">    mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法主要就是将之前创建的DecorView添加到WindowMager,并且设置mDecor.setVisibility(View.VISIBLE);那么getWindowManager方法就是之前在attach方法是创建的WindowManager,WindowManager是一个接口，看一下哪里实现了这个接口呢，按之前读源码的规则看实现类应该是WindowManagerImpl,看看还真有这个类。那么看看这个类是怎么实现的addView方法  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final class WindowManagerImpl implements WindowManager &#123;</span><br><span class="line">      @Override</span><br><span class="line">    public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) &#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow),mGlobal是什么呢，看看一下WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance()，看来这是个单例，全局都是这一个管理，那进去看看把  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public void addView(View view, ViewGroup.LayoutParams params,</span><br><span class="line">          Display display, Window parentWindow) &#123;</span><br><span class="line">      if (view == null) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;view must not be null&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (display == null) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;display must not be null&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      if (!(params instanceof WindowManager.LayoutParams)) &#123;</span><br><span class="line">          throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">      if (parentWindow != null) &#123;</span><br><span class="line">          parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          // If there&apos;s no parent, then hardware acceleration for this view is</span><br><span class="line">          // set from the application&apos;s hardware acceleration setting.</span><br><span class="line">          final Context context = view.getContext();</span><br><span class="line">          if (context != null</span><br><span class="line">                  &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                          &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) &#123;</span><br><span class="line">              wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ViewRootImpl root;</span><br><span class="line">      View panelParentView = null;</span><br><span class="line"></span><br><span class="line">      synchronized (mLock) &#123;</span><br><span class="line">          // Start watching for system property changes.</span><br><span class="line">          if (mSystemPropertyUpdater == null) &#123;</span><br><span class="line">              mSystemPropertyUpdater = new Runnable() &#123;</span><br><span class="line">                  @Override public void run() &#123;</span><br><span class="line">                      synchronized (mLock) &#123;</span><br><span class="line">                          for (int i = mRoots.size() - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">                              mRoots.get(i).loadSystemProperties();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;;</span><br><span class="line">              SystemProperties.addChangeCallback(mSystemPropertyUpdater);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          int index = findViewLocked(view, false);</span><br><span class="line">          if (index &gt;= 0) &#123;</span><br><span class="line">              if (mDyingViews.contains(view)) &#123;</span><br><span class="line">                  // Don&apos;t wait for MSG_DIE to make it&apos;s way through root&apos;s queue.</span><br><span class="line">                  mRoots.get(index).doDie();</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  throw new IllegalStateException(&quot;View &quot; + view</span><br><span class="line">                          + &quot; has already been added to the window manager.&quot;);</span><br><span class="line">              &#125;</span><br><span class="line">              // The previous removeView() had not completed executing. Now it has.</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          // If this is a panel window, then find the window it is being</span><br><span class="line">          // attached to for future reference.</span><br><span class="line">          if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">                  wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</span><br><span class="line">              final int count = mViews.size();</span><br><span class="line">              for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">                  if (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</span><br><span class="line">                      panelParentView = mViews.get(i);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          root = new ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">          view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">          mViews.add(view);</span><br><span class="line">          mRoots.add(root);</span><br><span class="line">          mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">          // do this last because it fires off messages to start doing things</span><br><span class="line">          try &#123;</span><br><span class="line">              root.setView(view, wparams, panelParentView);</span><br><span class="line">          &#125; catch (RuntimeException e) &#123;</span><br><span class="line">              // BadTokenException or InvalidDisplayException, clean up.</span><br><span class="line">              if (index &gt;= 0) &#123;</span><br><span class="line">                  removeViewLocked(index, true);</span><br><span class="line">              &#125;</span><br><span class="line">              throw e;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>看到addView方法里知道里面重点是，创建了一个ViewRootImpl对象，并且维护了三个链表，一个是View链表,就是传过来的DecorView，然后就是mRoots链表存放着当前创建的ViewRootImpl这个对象，还有就是mParams链表，存放的是LayoutParams属性。然后将view set到ViewRootImpl里，重点看一下这里做了什么  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123;</span><br><span class="line"></span><br><span class="line">      if (mView == null) &#123;</span><br><span class="line">            mView = view;</span><br><span class="line"></span><br><span class="line">            mAttachInfo.mDisplayState = mDisplay.getState();</span><br><span class="line">            mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</span><br><span class="line"></span><br><span class="line">            mViewLayoutDirectionInitial = mView.getRawLayoutDirection();</span><br><span class="line">            mFallbackEventHandler.setView(view);</span><br><span class="line">            mWindowAttributes.copyFrom(attrs);</span><br><span class="line">            if (mWindowAttributes.packageName == null) &#123;</span><br><span class="line">                mWindowAttributes.packageName = mBasePackageName;</span><br><span class="line">            &#125;</span><br><span class="line">            attrs = mWindowAttributes;</span><br><span class="line">            setTag();</span><br><span class="line"></span><br><span class="line">            if (DEBUG_KEEP_SCREEN_ON &amp;&amp; (mClientWindowLayoutFlags</span><br><span class="line">                    &amp; WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON) != 0</span><br><span class="line">                    &amp;&amp; (attrs.flags&amp;WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON) == 0) &#123;</span><br><span class="line">                Slog.d(mTag, &quot;setView: FLAG_KEEP_SCREEN_ON changed from true to false!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            // Keep track of the actual window flags supplied by the client.</span><br><span class="line">            mClientWindowLayoutFlags = attrs.flags;</span><br><span class="line"></span><br><span class="line">            setAccessibilityFocus(null, null);</span><br><span class="line"></span><br><span class="line">            if (view instanceof RootViewSurfaceTaker) &#123;</span><br><span class="line">                mSurfaceHolderCallback =</span><br><span class="line">                        ((RootViewSurfaceTaker)view).willYouTakeTheSurface();</span><br><span class="line">                if (mSurfaceHolderCallback != null) &#123;</span><br><span class="line">                    mSurfaceHolder = new TakenSurfaceHolder();</span><br><span class="line">                    mSurfaceHolder.setFormat(PixelFormat.UNKNOWN);</span><br><span class="line">                    mSurfaceHolder.addCallback(mSurfaceHolderCallback);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Compute surface insets required to draw at specified Z value.</span><br><span class="line">            // TODO: Use real shadow insets for a constant max Z.</span><br><span class="line">            if (!attrs.hasManualSurfaceInsets) &#123;</span><br><span class="line">                attrs.setSurfaceInsets(view, false /*manual*/, true /*preservePrevious*/);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CompatibilityInfo compatibilityInfo =</span><br><span class="line">                    mDisplay.getDisplayAdjustments().getCompatibilityInfo();</span><br><span class="line">            mTranslator = compatibilityInfo.getTranslator();</span><br><span class="line"></span><br><span class="line">            // If the application owns the surface, don&apos;t enable hardware acceleration</span><br><span class="line">            if (mSurfaceHolder == null) &#123;</span><br><span class="line">                // While this is supposed to enable only, it can effectively disable</span><br><span class="line">                // the acceleration too.</span><br><span class="line">                enableHardwareAcceleration(attrs);</span><br><span class="line">                final boolean useMTRenderer = MT_RENDERER_AVAILABLE</span><br><span class="line">                        &amp;&amp; mAttachInfo.mThreadedRenderer != null;</span><br><span class="line">                if (mUseMTRenderer != useMTRenderer) &#123;</span><br><span class="line">                    // Shouldn&apos;t be resizing, as it&apos;s done only in window setup,</span><br><span class="line">                    // but end just in case.</span><br><span class="line">                    endDragResizing();</span><br><span class="line">                    mUseMTRenderer = useMTRenderer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            boolean restore = false;</span><br><span class="line">            if (mTranslator != null) &#123;</span><br><span class="line">                mSurface.setCompatibilityTranslator(mTranslator);</span><br><span class="line">                restore = true;</span><br><span class="line">                attrs.backup();</span><br><span class="line">                mTranslator.translateWindowLayout(attrs);</span><br><span class="line">            &#125;</span><br><span class="line">            if (DEBUG_LAYOUT) Log.d(mTag, &quot;WindowLayout in setView:&quot; + attrs);</span><br><span class="line"></span><br><span class="line">            if (!compatibilityInfo.supportsScreen()) &#123;</span><br><span class="line">                attrs.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW;</span><br><span class="line">                mLastInCompatMode = true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mSoftInputMode = attrs.softInputMode;</span><br><span class="line">            mWindowAttributesChanged = true;</span><br><span class="line">            mWindowAttributesChangesFlag = WindowManager.LayoutParams.EVERYTHING_CHANGED;</span><br><span class="line">            mAttachInfo.mRootView = view;</span><br><span class="line">            mAttachInfo.mScalingRequired = mTranslator != null;</span><br><span class="line">            mAttachInfo.mApplicationScale =</span><br><span class="line">                    mTranslator == null ? 1.0f : mTranslator.applicationScale;</span><br><span class="line">            if (panelParentView != null) &#123;</span><br><span class="line">                mAttachInfo.mPanelParentWindowToken</span><br><span class="line">                        = panelParentView.getApplicationWindowToken();</span><br><span class="line">            &#125;</span><br><span class="line">            mAdded = true;</span><br><span class="line">            int res; /* = WindowManagerImpl.ADD_OKAY; */</span><br><span class="line"></span><br><span class="line">            // Schedule the first layout -before- adding to the window</span><br><span class="line">            // manager, to make sure we do the relayout before receiving</span><br><span class="line">            // any other events from the system.</span><br><span class="line">            requestLayout();</span><br><span class="line">            ..............</span><br><span class="line">            ............</span><br><span class="line">            .....</span><br><span class="line">            ..</span><br><span class="line">            .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看代码有两处重点，一个就是将view交给了ViewRootimpl处理，ViewRootimpl类里主要对View进行绘制，和事件的操作，然后调用了requestLayout()方法，那么咱们看一下requestLayout()这个方法是怎么处理的。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public void requestLayout() &#123;</span><br><span class="line">      if (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">          checkThread();</span><br><span class="line">          mLayoutRequested = true;</span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>接下来看一下scheduleTraversals()方法  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void scheduleTraversals() &#123;</span><br><span class="line">    if (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = true;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);</span><br><span class="line">        if (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下mTraversalRunnable里面执行了什么  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">final class TraversalRunnable implements Runnable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">final TraversalRunnable mTraversalRunnable = new TraversalRunnable();</span><br></pre></td></tr></table></figure>
<p>==看一下doTraversal这个方法== 回来重点看一下 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void doTraversal() &#123;</span><br><span class="line">    if (mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = false;</span><br><span class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">        if (mProfile) &#123;</span><br><span class="line">            Debug.startMethodTracing(&quot;ViewAncestor&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performTraversals();</span><br><span class="line"></span><br><span class="line">        if (mProfile) &#123;</span><br><span class="line">            Debug.stopMethodTracing();</span><br><span class="line">            mProfile = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在看一下这里performTraversals()这个方法吧  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">private void performTraversals() &#123;</span><br><span class="line">    .....</span><br><span class="line">    重点看这几个方法吧</span><br><span class="line"> if (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">                boolean focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                        (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != 0);</span><br><span class="line">                if (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                        || mHeight != host.getMeasuredHeight() || contentInsetsChanged ||</span><br><span class="line">                        updatedConfiguration) &#123;</span><br><span class="line">                    int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line">                    int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line"></span><br><span class="line">                    if (DEBUG_LAYOUT) Log.v(mTag, &quot;Ooops, something changed!  mWidth=&quot;</span><br><span class="line">                            + mWidth + &quot; measuredWidth=&quot; + host.getMeasuredWidth()</span><br><span class="line">                            + &quot; mHeight=&quot; + mHeight</span><br><span class="line">                            + &quot; measuredHeight=&quot; + host.getMeasuredHeight()</span><br><span class="line">                            + &quot; coveredInsetsChanged=&quot; + contentInsetsChanged);</span><br><span class="line"></span><br><span class="line">                     // Ask host how big it wants to be</span><br><span class="line">                    //注释1</span><br><span class="line"></span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                    // Implementation of weights from WindowManager.LayoutParams</span><br><span class="line">                    // We just grow the dimensions as needed and re-measure if</span><br><span class="line">                    // needs be</span><br><span class="line">                    int width = host.getMeasuredWidth();</span><br><span class="line">                    int height = host.getMeasuredHeight();</span><br><span class="line">                    boolean measureAgain = false;</span><br><span class="line"></span><br><span class="line">                    if (lp.horizontalWeight &gt; 0.0f) &#123;</span><br><span class="line">                        width += (int) ((mWidth - width) * lp.horizontalWeight);</span><br><span class="line">                        childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</span><br><span class="line">                                MeasureSpec.EXACTLY);</span><br><span class="line">                        measureAgain = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (lp.verticalWeight &gt; 0.0f) &#123;</span><br><span class="line">                        height += (int) ((mHeight - height) * lp.verticalWeight);</span><br><span class="line">                        childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</span><br><span class="line">                                MeasureSpec.EXACTLY);</span><br><span class="line">                        measureAgain = true;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (measureAgain) &#123;</span><br><span class="line">                        if (DEBUG_LAYOUT) Log.v(mTag,</span><br><span class="line">                                &quot;And hey let&apos;s measure once more: width=&quot; + width</span><br><span class="line">                                + &quot; height=&quot; + height);</span><br><span class="line">                        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    layoutRequested = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Not the first pass and no window/insets/visibility change but the window</span><br><span class="line">            // may have moved and we need check that and if so to update the left and right</span><br><span class="line">            // in the attach info. We translate only the window frame since on window move</span><br><span class="line">            // the window manager tells us only for the new frame but the insets are the</span><br><span class="line">            // same and we do not want to translate them more than once.</span><br><span class="line">            maybeHandleWindowMove(frame);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">        boolean triggerGlobalLayoutListener = didLayout</span><br><span class="line">                || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">        if (didLayout) &#123;</span><br><span class="line">        //注释2</span><br><span class="line">            performLayout(lp, mWidth, mHeight);</span><br><span class="line"></span><br><span class="line">            // By this point all views have been sized and positioned</span><br><span class="line">            // We can compute the transparent area</span><br><span class="line"></span><br><span class="line">            if ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != 0) &#123;</span><br><span class="line">                // start out transparent</span><br><span class="line">                // TODO: AVOID THAT CALL BY CACHING THE RESULT?</span><br><span class="line">                host.getLocationInWindow(mTmpLocation);</span><br><span class="line">                mTransparentRegion.set(mTmpLocation[0], mTmpLocation[1],</span><br><span class="line">                        mTmpLocation[0] + host.mRight - host.mLeft,</span><br><span class="line">                        mTmpLocation[1] + host.mBottom - host.mTop);</span><br><span class="line"></span><br><span class="line">                host.gatherTransparentRegion(mTransparentRegion);</span><br><span class="line">                if (mTranslator != null) &#123;</span><br><span class="line">                    mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</span><br><span class="line">                    mPreviousTransparentRegion.set(mTransparentRegion);</span><br><span class="line">                    mFullRedrawNeeded = true;</span><br><span class="line">                    // reconfigure window manager</span><br><span class="line">                    try &#123;</span><br><span class="line">                        mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</span><br><span class="line">                    &#125; catch (RemoteException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (DBG) &#123;</span><br><span class="line">                System.out.println(&quot;======================================&quot;);</span><br><span class="line">                System.out.println(&quot;performTraversals -- after setFrame&quot;);</span><br><span class="line">                host.debug();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (triggerGlobalLayoutListener) &#123;</span><br><span class="line">            mAttachInfo.mRecomputeGlobalAttributes = false;</span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnGlobalLayout();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (computesInternalInsets) &#123;</span><br><span class="line">            // Clear the original insets.</span><br><span class="line">            final ViewTreeObserver.InternalInsetsInfo insets = mAttachInfo.mGivenInternalInsets;</span><br><span class="line">            insets.reset();</span><br><span class="line"></span><br><span class="line">            // Compute new insets in place.</span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnComputeInternalInsets(insets);</span><br><span class="line">            mAttachInfo.mHasNonEmptyGivenInternalInsets = !insets.isEmpty();</span><br><span class="line"></span><br><span class="line">            // Tell the window manager.</span><br><span class="line">            if (insetsPending || !mLastGivenInsets.equals(insets)) &#123;</span><br><span class="line">                mLastGivenInsets.set(insets);</span><br><span class="line"></span><br><span class="line">                // Translate insets to screen coordinates if needed.</span><br><span class="line">                final Rect contentInsets;</span><br><span class="line">                final Rect visibleInsets;</span><br><span class="line">                final Region touchableRegion;</span><br><span class="line">                if (mTranslator != null) &#123;</span><br><span class="line">                    contentInsets = mTranslator.getTranslatedContentInsets(insets.contentInsets);</span><br><span class="line">                    visibleInsets = mTranslator.getTranslatedVisibleInsets(insets.visibleInsets);</span><br><span class="line">                    touchableRegion = mTranslator.getTranslatedTouchableArea(insets.touchableRegion);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    contentInsets = insets.contentInsets;</span><br><span class="line">                    visibleInsets = insets.visibleInsets;</span><br><span class="line">                    touchableRegion = insets.touchableRegion;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                try &#123;</span><br><span class="line">                    mWindowSession.setInsets(mWindow, insets.mTouchableInsets,</span><br><span class="line">                            contentInsets, visibleInsets, touchableRegion);</span><br><span class="line">                &#125; catch (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mFirst) &#123;</span><br><span class="line">            if (sAlwaysAssignFocus || !isInTouchMode()) &#123;</span><br><span class="line">                // handle first focus request</span><br><span class="line">                if (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                    Log.v(mTag, &quot;First: mView.hasFocus()=&quot; + mView.hasFocus());</span><br><span class="line">                &#125;</span><br><span class="line">                if (mView != null) &#123;</span><br><span class="line">                    if (!mView.hasFocus()) &#123;</span><br><span class="line">                        mView.restoreDefaultFocus();</span><br><span class="line">                        if (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                            Log.v(mTag, &quot;First: requested focused view=&quot; + mView.findFocus());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        if (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                            Log.v(mTag, &quot;First: existing focused view=&quot; + mView.findFocus());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Some views (like ScrollView) won&apos;t hand focus to descendants that aren&apos;t within</span><br><span class="line">                // their viewport. Before layout, there&apos;s a good change these views are size 0</span><br><span class="line">                // which means no children can get focus. After layout, this view now has size, but</span><br><span class="line">                // is not guaranteed to hand-off focus to a focusable child (specifically, the edge-</span><br><span class="line">                // case where the child has a size prior to layout and thus won&apos;t trigger</span><br><span class="line">                // focusableViewAvailable).</span><br><span class="line">                View focused = mView.findFocus();</span><br><span class="line">                if (focused instanceof ViewGroup</span><br><span class="line">                        &amp;&amp; ((ViewGroup) focused).getDescendantFocusability()</span><br><span class="line">                                == ViewGroup.FOCUS_AFTER_DESCENDANTS) &#123;</span><br><span class="line">                    focused.restoreDefaultFocus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final boolean changedVisibility = (viewVisibilityChanged || mFirst) &amp;&amp; isViewVisible;</span><br><span class="line">        final boolean hasWindowFocus = mAttachInfo.mHasWindowFocus &amp;&amp; isViewVisible;</span><br><span class="line">        final boolean regainedFocus = hasWindowFocus &amp;&amp; mLostWindowFocus;</span><br><span class="line">        if (regainedFocus) &#123;</span><br><span class="line">            mLostWindowFocus = false;</span><br><span class="line">        &#125; else if (!hasWindowFocus &amp;&amp; mHadWindowFocus) &#123;</span><br><span class="line">            mLostWindowFocus = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (changedVisibility || regainedFocus) &#123;</span><br><span class="line">            // Toasts are presented as notifications - don&apos;t present them as windows as well</span><br><span class="line">            boolean isToast = (mWindowAttributes == null) ? false</span><br><span class="line">                    : (mWindowAttributes.type == WindowManager.LayoutParams.TYPE_TOAST);</span><br><span class="line">            if (!isToast) &#123;</span><br><span class="line">                host.sendAccessibilityEvent(AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mFirst = false;</span><br><span class="line">        mWillDrawSoon = false;</span><br><span class="line">        mNewSurfaceNeeded = false;</span><br><span class="line">        mActivityRelaunched = false;</span><br><span class="line">        mViewVisibility = viewVisibility;</span><br><span class="line">        mHadWindowFocus = hasWindowFocus;</span><br><span class="line"></span><br><span class="line">        if (hasWindowFocus &amp;&amp; !isInLocalFocusMode()) &#123;</span><br><span class="line">            final boolean imTarget = WindowManager.LayoutParams</span><br><span class="line">                    .mayUseInputMethod(mWindowAttributes.flags);</span><br><span class="line">            if (imTarget != mLastWasImTarget) &#123;</span><br><span class="line">                mLastWasImTarget = imTarget;</span><br><span class="line">                InputMethodManager imm = InputMethodManager.peekInstance();</span><br><span class="line">                if (imm != null &amp;&amp; imTarget) &#123;</span><br><span class="line">                    imm.onPreWindowFocus(mView, hasWindowFocus);</span><br><span class="line">                    imm.onPostWindowFocus(mView, mView.findFocus(),</span><br><span class="line">                            mWindowAttributes.softInputMode,</span><br><span class="line">                            !mHasHadWindowFocus, mWindowAttributes.flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Remember if we must report the next draw.</span><br><span class="line">        if ((relayoutResult &amp; WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != 0) &#123;</span><br><span class="line">            reportNextDraw();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">        if (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">            if (mPendingTransitions != null &amp;&amp; mPendingTransitions.size() &gt; 0) &#123;</span><br><span class="line">                for (int i = 0; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        //注释3</span><br><span class="line">            performDraw();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (isViewVisible) &#123;</span><br><span class="line">                // Try again</span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; else if (mPendingTransitions != null &amp;&amp; mPendingTransitions.size() &gt; 0) &#123;</span><br><span class="line">                for (int i = 0; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).endChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = false;</span><br><span class="line">    ...........</span><br><span class="line">    ........</span><br><span class="line">    .....</span><br><span class="line">    ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进我标注的注释1，2，3是不是很熟悉，分别是  performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);performLayout(lp, mWidth, mHeight);performDraw();这三个方法，测量，布局，还有绘制，那么咱们分别跟进这几个方法看看最终是怎么调用的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) &#123;</span><br><span class="line">    if (mView == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用的是 mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); 看一下View是怎么实现的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public final void measure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">        boolean optical = isLayoutModeOptical(this);</span><br><span class="line">        if (optical != isLayoutModeOptical(mParent)) &#123;</span><br><span class="line">            Insets insets = getOpticalInsets();</span><br><span class="line">            int oWidth  = insets.left + insets.right;</span><br><span class="line">            int oHeight = insets.top  + insets.bottom;</span><br><span class="line">            widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</span><br><span class="line">            heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Suppress sign extension for the low bytes</span><br><span class="line">        long key = (long) widthMeasureSpec &lt;&lt; 32 | (long) heightMeasureSpec &amp; 0xffffffffL;</span><br><span class="line">        if (mMeasureCache == null) mMeasureCache = new LongSparseLongArray(2);</span><br><span class="line"></span><br><span class="line">        final boolean forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line"></span><br><span class="line">        // Optimize layout by avoiding an extra EXACTLY pass when the view is</span><br><span class="line">        // already measured as the correct size. In API 23 and below, this</span><br><span class="line">        // extra pass is required to make LinearLayout re-distribute weight.</span><br><span class="line">        final boolean specChanged = widthMeasureSpec != mOldWidthMeasureSpec</span><br><span class="line">                || heightMeasureSpec != mOldHeightMeasureSpec;</span><br><span class="line">        final boolean isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</span><br><span class="line">                &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY;</span><br><span class="line">        final boolean matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">                &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">        final boolean needsLayout = specChanged</span><br><span class="line">                &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</span><br><span class="line"></span><br><span class="line">        if (forceLayout || needsLayout) &#123;</span><br><span class="line">            // first clears the measured dimension flag</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line"></span><br><span class="line">            resolveRtlPropertiesIfNeeded();</span><br><span class="line"></span><br><span class="line">            int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key);</span><br><span class="line">            if (cacheIndex &lt; 0 || sIgnoreMeasureCache) &#123;</span><br><span class="line">                // measure ourselves, this should set the measured dimension flag back</span><br><span class="line">                onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                long value = mMeasureCache.valueAt(cacheIndex);</span><br><span class="line">                // Casting a long to int drops the high 32 bits, no mask needed</span><br><span class="line">                setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);</span><br><span class="line">                mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // flag not set, setMeasuredDimension() was not invoked, we raise</span><br><span class="line">            // an exception to warn the developer</span><br><span class="line">            if ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;View with id &quot; + getId() + &quot;: &quot;</span><br><span class="line">                        + getClass().getName() + &quot;#onMeasure() did not set the&quot;</span><br><span class="line">                        + &quot; measured dimension by calling&quot;</span><br><span class="line">                        + &quot; setMeasuredDimension()&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOldWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">        mOldHeightMeasureSpec = heightMeasureSpec;</span><br><span class="line"></span><br><span class="line">        mMeasureCache.put(key, ((long) mMeasuredWidth) &lt;&lt; 32 |</span><br><span class="line">                (long) mMeasuredHeight &amp; 0xffffffffL); // suppress sign extension</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这么多代码，挑出重点,onMeasure(widthMeasureSpec, heightMeasureSpec);这个是不是最熟悉了，在做自定义View的时候经常用到吧，那么在往下看看这个方法是怎么掉用的，还记的之前传过来的View应该是DecorView，那么看看这个类有没有实现onMeasure(widthMeasureSpec, heightMeasureSpec);这个方法。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">      final DisplayMetrics metrics = getContext().getResources().getDisplayMetrics();</span><br><span class="line">      final boolean isPortrait =</span><br><span class="line">              getResources().getConfiguration().orientation == ORIENTATION_PORTRAIT;</span><br><span class="line"></span><br><span class="line">      final int widthMode = getMode(widthMeasureSpec);</span><br><span class="line">      final int heightMode = getMode(heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">      boolean fixedWidth = false;</span><br><span class="line">      mApplyFloatingHorizontalInsets = false;</span><br><span class="line">      if (widthMode == AT_MOST) &#123;</span><br><span class="line">          final TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor;</span><br><span class="line">          if (tvw != null &amp;&amp; tvw.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">              final int w;</span><br><span class="line">              if (tvw.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">                  w = (int) tvw.getDimension(metrics);</span><br><span class="line">              &#125; else if (tvw.type == TypedValue.TYPE_FRACTION) &#123;</span><br><span class="line">                  w = (int) tvw.getFraction(metrics.widthPixels, metrics.widthPixels);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  w = 0;</span><br><span class="line">              &#125;</span><br><span class="line">              if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed width: &quot; + w);</span><br><span class="line">              final int widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">              if (w &gt; 0) &#123;</span><br><span class="line">                  widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                          Math.min(w, widthSize), EXACTLY);</span><br><span class="line">                  fixedWidth = true;</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                          widthSize - mFloatingInsets.left - mFloatingInsets.right,</span><br><span class="line">                          AT_MOST);</span><br><span class="line">                  mApplyFloatingHorizontalInsets = true;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mApplyFloatingVerticalInsets = false;</span><br><span class="line">      if (heightMode == AT_MOST) &#123;</span><br><span class="line">          final TypedValue tvh = isPortrait ? mWindow.mFixedHeightMajor</span><br><span class="line">                  : mWindow.mFixedHeightMinor;</span><br><span class="line">          if (tvh != null &amp;&amp; tvh.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">              final int h;</span><br><span class="line">              if (tvh.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">                  h = (int) tvh.getDimension(metrics);</span><br><span class="line">              &#125; else if (tvh.type == TypedValue.TYPE_FRACTION) &#123;</span><br><span class="line">                  h = (int) tvh.getFraction(metrics.heightPixels, metrics.heightPixels);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  h = 0;</span><br><span class="line">              &#125;</span><br><span class="line">              if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed height: &quot; + h);</span><br><span class="line">              final int heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">              if (h &gt; 0) &#123;</span><br><span class="line">                  heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                          Math.min(h, heightSize), EXACTLY);</span><br><span class="line">              &#125; else if ((mWindow.getAttributes().flags &amp; FLAG_LAYOUT_IN_SCREEN) == 0) &#123;</span><br><span class="line">                  heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                          heightSize - mFloatingInsets.top - mFloatingInsets.bottom, AT_MOST);</span><br><span class="line">                  mApplyFloatingVerticalInsets = true;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      getOutsets(mOutsets);</span><br><span class="line">      if (mOutsets.top &gt; 0 || mOutsets.bottom &gt; 0) &#123;</span><br><span class="line">          int mode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">          if (mode != MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">              int height = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">              heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                      height + mOutsets.top + mOutsets.bottom, mode);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (mOutsets.left &gt; 0 || mOutsets.right &gt; 0) &#123;</span><br><span class="line">          int mode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">          if (mode != MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">              int width = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">              widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                      width + mOutsets.left + mOutsets.right, mode);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">      int width = getMeasuredWidth();</span><br><span class="line">      boolean measure = false;</span><br><span class="line"></span><br><span class="line">      widthMeasureSpec = MeasureSpec.makeMeasureSpec(width, EXACTLY);</span><br><span class="line"></span><br><span class="line">      if (!fixedWidth &amp;&amp; widthMode == AT_MOST) &#123;</span><br><span class="line">          final TypedValue tv = isPortrait ? mWindow.mMinWidthMinor : mWindow.mMinWidthMajor;</span><br><span class="line">          if (tv.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">              final int min;</span><br><span class="line">              if (tv.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">                  min = (int)tv.getDimension(metrics);</span><br><span class="line">              &#125; else if (tv.type == TypedValue.TYPE_FRACTION) &#123;</span><br><span class="line">                  min = (int)tv.getFraction(mAvailableWidth, mAvailableWidth);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  min = 0;</span><br><span class="line">              &#125;</span><br><span class="line">              if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Adjust for min width: &quot; + min + &quot;, value::&quot;</span><br><span class="line">                      + tv.coerceToString() + &quot;, mAvailableWidth=&quot; + mAvailableWidth);</span><br><span class="line"></span><br><span class="line">              if (width &lt; min) &#123;</span><br><span class="line">                  widthMeasureSpec = MeasureSpec.makeMeasureSpec(min, EXACTLY);</span><br><span class="line">                  measure = true;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // TODO: Support height?</span><br><span class="line"></span><br><span class="line">      if (measure) &#123;</span><br><span class="line">          super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>具体的测量的流程在这里就不讲了，主要看一下他整体的调用流程吧，这里又调用了super.onMeasure(widthMeasureSpec, heightMeasureSpec);<br>那么看一下他的父类是怎么实现的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">       int count = getChildCount();</span><br><span class="line"></span><br><span class="line">       final boolean measureMatchParentChildren =</span><br><span class="line">               MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</span><br><span class="line">               MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</span><br><span class="line">       mMatchParentChildren.clear();</span><br><span class="line"></span><br><span class="line">       int maxHeight = 0;</span><br><span class="line">       int maxWidth = 0;</span><br><span class="line">       int childState = 0;</span><br><span class="line"></span><br><span class="line">       for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">           final View child = getChildAt(i);</span><br><span class="line">           if (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</span><br><span class="line">               measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);</span><br><span class="line">               final LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">               maxWidth = Math.max(maxWidth,</span><br><span class="line">                       child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</span><br><span class="line">               maxHeight = Math.max(maxHeight,</span><br><span class="line">                       child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</span><br><span class="line">               childState = combineMeasuredStates(childState, child.getMeasuredState());</span><br><span class="line">               if (measureMatchParentChildren) &#123;</span><br><span class="line">                   if (lp.width == LayoutParams.MATCH_PARENT ||</span><br><span class="line">                           lp.height == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                       mMatchParentChildren.add(child);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // Account for padding too</span><br><span class="line">       maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</span><br><span class="line">       maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">       // Check against our minimum height and width</span><br><span class="line">       maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</span><br><span class="line">       maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</span><br><span class="line"></span><br><span class="line">       // Check against our foreground&apos;s minimum height and width</span><br><span class="line">       final Drawable drawable = getForeground();</span><br><span class="line">       if (drawable != null) &#123;</span><br><span class="line">           maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</span><br><span class="line">           maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</span><br><span class="line">               resolveSizeAndState(maxHeight, heightMeasureSpec,</span><br><span class="line">                       childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</span><br><span class="line"></span><br><span class="line">       count = mMatchParentChildren.size();</span><br><span class="line">       if (count &gt; 1) &#123;</span><br><span class="line">           for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">               final View child = mMatchParentChildren.get(i);</span><br><span class="line">               final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">               final int childWidthMeasureSpec;</span><br><span class="line">               if (lp.width == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                   final int width = Math.max(0, getMeasuredWidth()</span><br><span class="line">                           - getPaddingLeftWithForeground() - getPaddingRightWithForeground()</span><br><span class="line">                           - lp.leftMargin - lp.rightMargin);</span><br><span class="line">                   childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                           width, MeasureSpec.EXACTLY);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</span><br><span class="line">                           getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</span><br><span class="line">                           lp.leftMargin + lp.rightMargin,</span><br><span class="line">                           lp.width);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               final int childHeightMeasureSpec;</span><br><span class="line">               if (lp.height == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                   final int height = Math.max(0, getMeasuredHeight()</span><br><span class="line">                           - getPaddingTopWithForeground() - getPaddingBottomWithForeground()</span><br><span class="line">                           - lp.topMargin - lp.bottomMargin);</span><br><span class="line">                   childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                           height, MeasureSpec.EXACTLY);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</span><br><span class="line">                           getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</span><br><span class="line">                           lp.topMargin + lp.bottomMargin,</span><br><span class="line">                           lp.height);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里面主要遍历了一下他的子view ,然后调用了子View的measure方法，到这里测量的方法就已经结束了，其他两个方法就不在带大家看了，基本调用都是相同的。<br>到此View的整体显示流程都已经跟大家过了一遍。  </p>
<p>总结一下：  </p>
<p>1.首先在ActivityThread启动Activity OnCreate 方法之前调用的Attach方法，在里面创建了PhoneWindow对象，同时通过Ibinder获取到WMS进行管理PhoneWindow.  </p>
<p>2.在执行OnCreate()方法里的SetContentView()方法时，调用了之前创建PhoneWindow方法里的setContentView方法，在这里面创建了DecorView对象，并且将传入的布局ID，通过LayoutInflate 类进行处理创建反射得到对应View，也就是变量mContentView 。  </p>
<p>3.在ActivityThread执行Activity里的OnResume相关方法时，执行了一个方法makevisible()，里面将之前创建好的DecorView,set到WindowManager,这是一个接口，实现这个接口的是WindowManagerImpl,在这里，又调用了WindowManagerGlobal,这里是一个单例。</p>
<p>4.在WindowManagerGlobal里创建了一个类ViewRootImpl，并且维护这三个链表，分别存放创建的ViewRootImpl,和传进来的View ,还有传进来的相关属性LayoutParams.并且将传进来的View传入到ViewRootImpl 中。  </p>
<p>5.在viewRootImpl 中对view 进行了相关的测量，布局，绘制的操作，最终完成View的显示</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/30/Android-View加载流程分析/" data-id="cjv37924w00022uladd66ela4" class="article-share-link">Share</a>
      
      
        <a href="/2019/04/30/Android-View加载流程分析/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2019/04/30/Android-View加载流程分析/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/04/30/LayoutInflate加载详解/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          LayoutInflate加载详解
        
      </div>
    </a>
  
  
    <a href="/2019/04/23/9-0系统启动流程源码分析“/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>



  <section id="comments" class="vcomment">

  </section>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/30/LayoutInflate加载详解/">LayoutInflate加载详解</a>
          </li>
        
          <li>
            <a href="/2019/04/30/Android-View加载流程分析/">Android View加载流程分析</a>
          </li>
        
          <li>
            <a href="/2019/04/23/9-0系统启动流程源码分析“/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/04/23/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 pengqiming<br>
      Powered by <a href="https://pqmpqm123.github.io/" target="_blank">PQM</a>
    </div>
  </div>
  <div>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1277361153'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s96.cnzz.com/z_stat.php%3Fid%3D1277361153%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>




  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = 'false' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "QI2RXf5tr8YR663tiS2jo5ux-gzGzoHsz",
        appKey: "BmGifKBVH0zFPkjejdlW3bEe",
        placeholder: "聊一聊",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>